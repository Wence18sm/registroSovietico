<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Registro Año Soviético</title>

  <!-- React -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
  <div id="root"></div>

  <!-- Firebase v9 Modular SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { 
      getFirestore, 
      collection, 
      addDoc, 
      updateDoc, 
      doc, 
      onSnapshot 
    } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

    // Tu configuración de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDRwMHPEmaHNf_YtiAcciP76F1D41qzNZQ",
      authDomain: "trackersovietico.firebaseapp.com",
      projectId: "trackersovietico",
      storageBucket: "trackersovietico.firebasestorage.app",
      messagingSenderId: "948696302821",
      appId: "1:948696302821:web:5d5aae1d12d153eaf1800c",
      measurementId: "G-FCP9ZW9NHC"
    };

    // Inicializar Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Hacer Firebase disponible globalmente para React
    window.firebaseDB = db;
    window.firebaseCollection = collection;
    window.firebaseAddDoc = addDoc;
    window.firebaseUpdateDoc = updateDoc;
    window.firebaseDoc = doc;
    window.firebaseOnSnapshot = onSnapshot;
  </script>

  <script type="text/babel">
    function SovietTrainingTracker() {
      const [comrades, setComrades] = React.useState([]);
      const [newComradeName, setNewComradeName] = React.useState('');
      const [showAddForm, setShowAddForm] = React.useState(false);

      // Cargar datos desde Firestore
      React.useEffect(() => {
        const comradesRef = window.firebaseCollection(window.firebaseDB, "comrades");
        
        const unsubscribe = window.firebaseOnSnapshot(comradesRef, (snapshot) => {
          const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          // Filtrar eliminados y agregar detección de promociones
          const processedData = data.filter(c => !c.removed).map(comrade => {
            const currentRank = getRank(comrade.count);
            const previousCount = comrade.previousCount || 0;
            const previousRank = getRank(previousCount);
            
            return {
              ...comrade,
              wasPromoted: currentRank.title !== previousRank.title && comrade.count > previousCount
            };
          });
          setComrades(processedData);
        });
        
        return unsubscribe;
      }, []);

      // Función getRank modificada para intervalos de 15
      const getRank = (count) => {
        if (count >= 130) return { title: "Héroe de la Madre Patria", icon: "🚩", color: "text-yellow-600" };
        if (count >= 120) return { title: "Guardián Rojo", icon: "🛡️", color: "text-yellow-500" };
        if (count >= 110) return { title: "Titán del Proletariado", icon: "⚒️", color: "text-purple-600" };
        if (count >= 100) return { title: "Centinela de Acero", icon: "🪖", color: "text-red-700" };
        if (count >= 90) return { title: "Martillo del Pueblo", icon: "🔨", color: "text-red-600" };
        if (count >= 80) return { title: "Escudo de la Revolución", icon: "🛡️", color: "text-red-500" };
        if (count >= 60) return { title: "Comandante del Ejército Rojo", icon: "⭐", color: "text-blue-700" };
        if (count >= 50) return { title: "Luchador del Pueblo", icon: "💪", color: "text-blue-600" };
        if (count >= 40) return { title: "Soldado de Hierro", icon: "⚔️", color: "text-blue-500" };
        if (count >= 30) return { title: "Plebeyo Valiente", icon: "🔥", color: "text-green-700" };
        if (count >= 20) return { title: "Obrero Disciplinado", icon: "🛠️", color: "text-green-600" };
        if (count >= 10) return { title: "Recluta Rojo", icon: "⭐", color: "text-green-500" };
        return { title: "Nuevo vikingo", icon: "👤", color: "text-gray-500" };
      };


      // Función para obtener el siguiente rango y cuánto falta
      const getNextRankInfo = (count) => {
        const currentLevel = Math.floor(count / 10);
        const nextThreshold = (currentLevel + 1) * 10;
        const remaining = nextThreshold - count;
        return { nextThreshold, remaining };
      };

      const getMotivationalPhrase = () => {
        const phrases = [
          "¡La disciplina forja el carácter!",
          "Cada repetición es un paso hacia la grandeza",
          "El sudor de hoy es la victoria de mañana",
          "En la unión está la fuerza",
          "¡Por la gloria del colectivo!",
          "La perseverancia vence a la resistencia",
          "Entrenar es servir a la patria",
          "¡Adelante, camarada!"
        ];
        return phrases[Math.floor(Math.random() * phrases.length)];
      };

      const addComrade = async () => {
        if (newComradeName.trim()) {
          try {
            const comradesRef = window.firebaseCollection(window.firebaseDB, "comrades");
            await window.firebaseAddDoc(comradesRef, {
              name: newComradeName.trim().toLowerCase(),
              count: 0,
              previousCount: 0,
              lastTraining: null,
              removed: false
            });
            setNewComradeName('');
            setShowAddForm(false);
          } catch (error) {
            console.error("Error agregando camarada:", error);
            alert("Error al agregar camarada. Revisa la consola.");
          }
        }
      };

      const incrementCount = async (id, currentCount) => {
        try {
          const docRef = window.firebaseDoc(window.firebaseDB, "comrades", id);
          await window.firebaseUpdateDoc(docRef, { 
            previousCount: currentCount,
            count: currentCount + 1, 
            lastTraining: new Date().toLocaleDateString() 
          });
        } catch (error) {
          console.error("Error incrementando contador:", error);
          alert("Error al incrementar contador. Revisa la consola.");
        }
      };

      const removeComrade = async (id) => {
        try {
          const docRef = window.firebaseDoc(window.firebaseDB, "comrades", id);
          await window.firebaseUpdateDoc(docRef, { removed: true });
        } catch (error) {
          console.error("Error removiendo camarada:", error);
          alert("Error al remover camarada. Revisa la consola.");
        }
      };

      const totalTrainings = comrades.reduce((sum, c) => sum + c.count, 0);
      const averageTrainings = comrades.length > 0 ? (totalTrainings / comrades.length).toFixed(1) : 0;
      const yearProgress = totalTrainings > 0 ? Math.min((totalTrainings / (130 * comrades.length)) * 100, 100).toFixed(1) : 0;

      return (
        <div className="min-h-screen bg-gradient-to-br from-red-50 to-red-100 p-4 md:p-6">
          <div className="max-w-2xl mx-auto">
            {/* Header soviético mejorado */}
            <div className="text-center mb-8 relative">
              <div className="mb-4 text-6xl">☭</div>
              <h1 className="text-2xl md:text-3xl font-bold text-red-800 mb-2">
                VIKING BOX - AÑO SOVIÉTICO
              </h1>
              <p className="text-red-600 text-sm mb-4">
                "No es menos tonto el más listo, sino el que menos tonto es"
              </p>
              <div className="bg-red-600 text-white p-2 rounded text-sm">
                Progreso vikingo: {yearProgress}% hacia la meta anual (130 pp)
              </div>
            </div>

            {/* Estadísticas heroicas */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
              <div className="bg-white p-4 rounded-lg border-2 border-red-200 relative overflow-hidden">
                <div className="absolute top-0 right-0 w-8 h-8 bg-red-600 transform rotate-45 translate-x-4 -translate-y-4"></div>
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-xs text-red-600 uppercase tracking-wide font-bold">vikingos</p>
                    <p className="text-2xl font-bold text-gray-900">{comrades.length}</p>
                  </div>
                  <div className="h-6 w-6 text-red-600">👥</div>
                </div>
              </div>
              
              <div className="bg-white p-4 rounded-lg border-2 border-red-200 relative overflow-hidden">
                <div className="absolute top-0 right-0 w-8 h-8 bg-red-600 transform rotate-45 translate-x-4 -translate-y-4"></div>
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-xs text-red-600 uppercase tracking-wide font-bold">Entrenamientos totales</p>
                    <p className="text-2xl font-bold text-gray-900">{totalTrainings}</p>
                  </div>
                  <div className="h-6 w-6 text-red-600">📈</div>
                </div>
              </div>
              
              <div className="bg-white p-4 rounded-lg border-2 border-red-200 relative overflow-hidden">
                <div className="absolute top-0 right-0 w-8 h-8 bg-red-600 transform rotate-45 translate-x-4 -translate-y-4"></div>
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-xs text-red-600 uppercase tracking-wide font-bold">Promedio por Vikingo</p>
                    <p className="text-2xl font-bold text-gray-900">{averageTrainings}</p>
                  </div>
                  <div className="h-6 w-6 text-red-600">🏅</div>
                </div>
              </div>
            </div>

            {/* Frase motivacional */}
            {comrades.length > 0 && (
              <div className="bg-red-600 text-white p-4 rounded-lg mb-6 text-center">
                <p className="text-sm italic">"{getMotivationalPhrase()}"</p>
              </div>
            )}

            {/* Botón agregar camarada mejorado */}
            {!showAddForm && (
              <button onClick={() => setShowAddForm(true)}
                className="w-full mb-6 p-4 bg-white border-2 border-dashed border-red-300 rounded-lg text-red-600 hover:border-red-400 hover:text-red-700 hover:bg-red-50 transition-colors flex items-center justify-center gap-2 font-medium">
                <span className="text-xl">+</span>
                Nuevo Vikingo
              </button>
            )}

            {/* Formulario mejorado */}
            {showAddForm && (
              <div className="bg-white p-4 rounded-lg border-2 border-red-200 mb-6">
                <h3 className="text-red-800 font-bold mb-3">Registro de nuevo vikingo</h3>
                <div className="flex flex-col sm:flex-row gap-2">
                  <input value={newComradeName} onChange={(e) => setNewComradeName(e.target.value)}
                    placeholder="Nombre del Vikingo"
                    className="flex-1 px-3 py-2 border-2 border-red-300 rounded text-sm focus:outline-none focus:border-red-500"
                    onKeyPress={(e) => e.key === 'Enter' && addComrade()}
                    autoFocus />
                  <div className="flex gap-2">
                    <button onClick={addComrade} className="px-4 py-2 bg-red-600 text-white rounded text-sm hover:bg-red-700 transition-colors font-medium">Agregar</button>
                    <button onClick={() => { setShowAddForm(false); setNewComradeName(''); }}
                      className="px-4 py-2 border-2 border-red-300 rounded text-sm hover:bg-red-50 transition-colors">Cancelar</button>
                  </div>
                </div>
              </div>
            )}

            {/* Lista de camaradas mejorada */}
            <div className="space-y-4">
              {comrades.length === 0 ? (
                <div className="text-center py-12 text-red-600">
                  <div className="text-4xl mb-4">🏭</div>
                  <p className="text-sm font-medium">El cuartel está vacío</p>
                  <p className="text-xs mt-1">recluta tu primer Vikingo para comenzar el año sovietico</p>
                </div>
              ) : (
                comrades.sort((a, b) => b.count - a.count).map((comrade, index) => {
                  const nextRankInfo = getNextRankInfo(comrade.count);
                  
                  return (
                    <div key={comrade.id}
                      className={`bg-white p-4 rounded-lg border-2 transition-all duration-300 ${
                        comrade.wasPromoted 
                          ? 'border-yellow-400 bg-yellow-50 shadow-lg' 
                          : index === 0 
                            ? 'border-red-400 bg-red-50' 
                            : 'border-red-200'
                      }`}>
                      <div className="flex items-center justify-between">
                        <div className="flex-1">
                          <div className="flex items-center gap-2 mb-2">
                            <span className="text-lg">{getRank(comrade.count).icon}</span>
                            <h3 className="font-bold text-gray-900">{comrade.name}</h3>
                            {index === 0 && <div className="text-yellow-500">👑</div>}
                            {comrade.wasPromoted && (
                              <div className="animate-pulse text-yellow-500">🎖️ ¡PROMOCIÓN!</div>
                            )}
                          </div>
                          
                          <div className={`text-sm font-medium mb-1 ${getRank(comrade.count).color}`}>
                            {getRank(comrade.count).title}
                          </div>
                          
                          <div className="flex items-center gap-4 text-sm text-gray-600">
                            <span className="font-medium">
                              {comrade.count} {comrade.count === 1 ? 'entrenamiento' : 'entrenamientos'}
                            </span>
                            {comrade.lastTraining && (
                              <span className="text-xs">
                                último: {comrade.lastTraining}
                              </span>
                            )}
                          </div>

                          {/* Barra de progreso hacia siguiente rango (intervalos de 10) */}
                          <div className="mt-2">
                            <div className="w-full bg-gray-200 rounded-full h-2">
                              <div 
                                className="bg-red-600 h-2 rounded-full transition-all duration-300"
                                style={{
                                  width: `${((comrade.count % 10) / 10) * 100}%`
                                }}
                              ></div>
                            </div>
                            <div className="text-xs text-gray-500 mt-1">
                              {nextRankInfo.remaining} Entrenamientos para siguiente rango
                            </div>
                          </div>
                        </div>
                        
                        <div className="flex items-center gap-3">
                          <div className="text-right">
                            <div className="text-3xl font-bold text-red-600">
                              {comrade.count}
                            </div>
                          </div>
                          
                          <button onClick={() => incrementCount(comrade.id, comrade.count)}
                            className="h-16 w-16 bg-red-600 text-white rounded-full flex items-center justify-center hover:bg-red-700 transition-all duration-200 text-xl font-bold shadow-lg hover:shadow-xl transform hover:scale-105">
                            +1
                          </button>
                          
                          <button onClick={() => removeComrade(comrade.id)}
                            className="ml-2 text-gray-400 hover:text-red-500 transition-colors text-lg"
                            title="dar de baja">
                            ×
                          </button>
                        </div>
                      </div>
                    </div>
                  );
                })
              )}
            </div>

            {/* Footer heroico */}
            {comrades.length > 0 && (
              <div className="text-center mt-12 pt-8 border-t-2 border-red-200">
                <div className="text-2xl mb-2">⚡</div>
                <p className="text-sm text-red-600 font-medium">
                  "La disciplina es la madre de la victoria"
                </p>
                <p className="text-xs text-gray-500 mt-1">
                  Año soviético en progreso · ¡Gloria al trabajo duro!
                </p>
              </div>
            )}
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<SovietTrainingTracker />);
  </script>
</body>
</html>


